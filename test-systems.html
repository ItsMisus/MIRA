<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Nuovi Sistemi</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            color: #fff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #222;
            border-left: 4px solid #9b59b6;
            border-radius: 6px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .test-result.pass {
            background: #27ae60;
            color: #fff;
        }
        .test-result.fail {
            background: #e74c3c;
            color: #fff;
        }
        .test-result.info {
            background: #3498db;
            color: #fff;
        }
        button {
            padding: 10px 20px;
            background: #9b59b6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        button:hover {
            background: #8e44ad;
        }
        h1, h2 {
            color: #9b59b6;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ TEST SISTEMI OTTIMIZZATI</h1>
        
        <div id="testResults"></div>
        
        <div class="test-section">
            <h2>Azioni Manuali</h2>
            <button onclick="testStorage()">Test Storage System</button>
            <button onclick="testUtilities()">Test Utilities</button>
            <button onclick="testFileUpload()">Test File Upload</button>
            <button onclick="testAll()">Esegui Tutti i Test</button>
            <button onclick="clearResults()">Pulisci Risultati</button>
        </div>
    </div>

    <!-- New Optimization Systems -->
    <script src="storage.js"></script>
    <script src="file-upload.js"></script>
    <script src="languages.js"></script>
    <script src="utilities.js"></script>

    <script>
        const resultsDiv = document.getElementById('testResults');

        function addResult(title, status, message) {
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            result.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultsDiv.appendChild(result);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testStorage() {
            clearResults();
            addResult('Storage', 'info', 'Inizio test storage system...');

            try {
                // Test 1: Save
                const testData = { test: 'data', timestamp: Date.now() };
                const saveResult = await window.storage.save('test-key', testData);
                
                if (saveResult.success) {
                    addResult('Storage Save', 'pass', `‚úÖ Dati salvati in: ${saveResult.method}`);
                } else {
                    addResult('Storage Save', 'fail', `‚ùå Errore: ${saveResult.error}`);
                    return;
                }

                // Test 2: Load
                const loadResult = await window.storage.load('test-key');
                
                if (loadResult.success && JSON.stringify(loadResult.data) === JSON.stringify(testData)) {
                    addResult('Storage Load', 'pass', `‚úÖ Dati caricati da: ${loadResult.method}`);
                } else {
                    addResult('Storage Load', 'fail', `‚ùå Errore nel caricamento`);
                    return;
                }

                // Test 3: Clear
                const clearResult = await window.storage.clearAll();
                if (clearResult.success) {
                    addResult('Storage Clear', 'pass', `‚úÖ Storage pulito`);
                } else {
                    addResult('Storage Clear', 'fail', `‚ùå Errore nel clearing`);
                }

                addResult('Storage Summary', 'pass', `‚úÖ Storage system funziona correttamente!`);

            } catch (err) {
                addResult('Storage Error', 'fail', `‚ùå ${err.message}`);
            }
        }

        async function testUtilities() {
            clearResults();
            addResult('Utilities', 'info', 'Inizio test utilities...');

            try {
                let passed = 0;
                let total = 0;

                // Test 1: createProductCard
                total++;
                if (typeof window.createProductCard === 'function') {
                    const card = window.createProductCard({
                        name: 'Test PC',
                        price: 999,
                        desc: 'Test descrizione',
                        img: 'test.jpg'
                    });
                    if (card && card.className === 'product') {
                        addResult('createProductCard', 'pass', '‚úÖ Funzione OK');
                        passed++;
                    } else {
                        addResult('createProductCard', 'fail', '‚ùå Card creation fallita');
                    }
                } else {
                    addResult('createProductCard', 'fail', '‚ùå Funzione non trovata');
                }

                // Test 2: filterByCategory
                total++;
                if (typeof window.filterByCategory === 'function') {
                    const testProducts = [
                        { name: 'PC1', categories: ['Gaming'] },
                        { name: 'PC2', categories: ['Office'] }
                    ];
                    const filtered = window.filterByCategory(testProducts, 'Gaming');
                    if (filtered.length === 1 && filtered[0].name === 'PC1') {
                        addResult('filterByCategory', 'pass', '‚úÖ Funzione OK');
                        passed++;
                    } else {
                        addResult('filterByCategory', 'fail', '‚ùå Filter fallito');
                    }
                } else {
                    addResult('filterByCategory', 'fail', '‚ùå Funzione non trovata');
                }

                // Test 3: formatPrice
                total++;
                if (typeof window.formatPrice === 'function') {
                    const price = window.formatPrice(999.5);
                    if (price === '‚Ç¨ 999.50') {
                        addResult('formatPrice', 'pass', '‚úÖ Funzione OK');
                        passed++;
                    } else {
                        addResult('formatPrice', 'fail', `‚ùå Returned: ${price}`);
                    }
                } else {
                    addResult('formatPrice', 'fail', '‚ùå Funzione non trovata');
                }

                // Test 4: paginateProducts
                total++;
                if (typeof window.paginateProducts === 'function') {
                    const products = Array(30).fill({name: 'PC'});
                    const result = window.paginateProducts(products, 1, 12);
                    if (result.items.length === 12 && result.pages === 3) {
                        addResult('paginateProducts', 'pass', '‚úÖ Funzione OK');
                        passed++;
                    } else {
                        addResult('paginateProducts', 'fail', '‚ùå Pagination fallita');
                    }
                } else {
                    addResult('paginateProducts', 'fail', '‚ùå Funzione non trovata');
                }

                addResult('Utilities Summary', 'pass', `‚úÖ ${passed}/${total} funzioni OK`);

            } catch (err) {
                addResult('Utilities Error', 'fail', `‚ùå ${err.message}`);
            }
        }

        async function testFileUpload() {
            clearResults();
            addResult('FileUpload', 'info', 'Inizio test file upload system...');

            try {
                // Test 1: Validate file
                const mockFile = {
                    name: 'test.png',
                    size: 1024 * 100, // 100KB
                    type: 'image/png'
                };

                const validation = window.fileUpload.validateFile(mockFile);
                if (validation.valid) {
                    addResult('File Validation', 'pass', '‚úÖ Validazione OK');
                } else {
                    addResult('File Validation', 'fail', `‚ùå ${validation.errors.join(', ')}`);
                }

                // Test 2: Sanitize filename
                const dirtyName = 'Test File 123!@#.png';
                const cleanName = window.fileUpload.sanitizeFileName(dirtyName);
                if (cleanName && !cleanName.match(/[^a-z0-9\-_.]/)) {
                    addResult('Filename Sanitization', 'pass', `‚úÖ ${cleanName}`);
                } else {
                    addResult('Filename Sanitization', 'fail', `‚ùå ${cleanName}`);
                }

                // Test 3: Check upload requirements
                const uploadInput = document.getElementById('imageInput');
                if (typeof window.fileUpload.uploadFile === 'function') {
                    addResult('Upload Function', 'pass', '‚úÖ uploadFile disponibile');
                } else {
                    addResult('Upload Function', 'fail', '‚ùå uploadFile non trovata');
                }

                addResult('FileUpload Summary', 'pass', '‚úÖ File upload system OK');

            } catch (err) {
                addResult('FileUpload Error', 'fail', `‚ùå ${err.message}`);
            }
        }

        async function testAll() {
            clearResults();
            await testStorage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testUtilities();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testFileUpload();
        }

        // Auto test on load
        window.addEventListener('load', () => {
            addResult('Sistema', 'info', '‚úÖ Test page caricata');
            addResult('Storage', 'info', window.storage ? '‚úÖ Storage disponibile' : '‚ùå Storage non trovato');
            addResult('FileUpload', 'info', window.fileUpload ? '‚úÖ FileUpload disponibile' : '‚ùå FileUpload non trovato');
            addResult('Utilities', 'info', window.displayProducts ? '‚úÖ Utilities disponibili' : '‚ùå Utilities non trovate');
        });
    </script>
</body>
</html>
